---
title: "All Geocoded DC"
author: "Bill Lang"
date: "11/1/2020"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggmap)
```


```{r}
#DC = read.csv("C:/Users/the36/Desktop/DataRA/hiphop_insyle/hiphop_dc.csv")
#DChandcheck = read.csv("C:/Users/the36/Downloads/dc_handcheck.csv")

#save(DC, file = "DC.RData")
#save(DChandcheck, file = "DChandcheck.RData")
```


```{r}
load(file = "DC.RData")
load(file = "DChandcheck.RData")
```


```{r}
DC
DChandcheck


DC %>% filter(Area != "")
DC %>% group_by(Column) %>% summarise(count = n()) %>% arrange(desc(count))
DC %>% group_by(Area) %>% summarise(count = n()) %>% arrange(desc(count))

#70,785 with and 63,725  without area, 

DChandcheck <- DChandcheck %>% mutate(Area = Ã¯..Area) %>% select(Area,State) %>% distinct() %>% filter(State != "")

DChandcheck %>%  filter(Area == "north arlington")
DChandcheck %>% group_by(Area) %>% summarise(count = n()) %>% arrange(desc(count))

DC <- DC %>% mutate(Area = tolower(Area)) %>% left_join(DChandcheck, by = 'Area') 
```

Dataset Specific preparation


#Run in Open Street Map

#House Number First
#Then run the small location (if no small area then large area)


#Then try the same thing through google

#This is the final dataset

```{r}
DC$Area <- tolower(DC$Area)
DC$Column <- tolower(DC$Column)
DC$Street <- tolower(DC$Street)


DC <- DC %>% mutate(location = ifelse(Area != "", as.character(Area), as.character(Column))) 

%>%   mutate(location = case_when(
    str_detect(location, "n dallas") ~ "north dallas",
    str_detect(location, "e dallas") ~ "east dallas",
    str_detect(location, "dallas") ~ "",
    str_detect(location, "suburban") ~ "",
    str_detect(location, "N NW Hwy") ~ "N NW Highway",
    str_detect(location, "n nw hwy, midway rd to central expwy") ~ "N NW Highway",
    str_detect(location, "N Northwest Hwy") ~ "N NW Highway",
    str_detect(location, "n nw hwy, w midway rd") ~ "N NW Highway",
    str_detect(location, "n of northwest highway") ~ "N NW Highway",
    str_detect(location, "n of nw hwy") ~ "N NW Highway",
    str_detect(location, "n nw hwy, e central expwy") ~ "N NW Highway",
    str_detect(location, "n of lbj") ~ "n lbj",
    str_detect(location, "n lbj, e addison, w richardson") ~ "n lbj",
    str_detect(location, "north of northwest highway") ~ "N NW Highway",
    str_detect(location, "oak cliff, w beckley") ~ "oak cliff",
    str_detect(location, "white rock lake - east") ~ "east white rock lake",
    str_detect(location, "e white rock lake") ~ "east white rock lake",
    TRUE ~ location
    )
  )
DC %>% filter(location != "")

DC <- DC %>% unite(Address, c("Hse.No","Street"), sep = " ",remove = FALSE)
DC$Address <- paste(DC$Address, ", DC")
DC$Address <- trimws(DC$Address)
DC$Address <- sapply(DC$Address, function(x) gsub("#", "", x))
DC$Address <- sapply(DC$Address, function(x) gsub("near", "", x))
DC$Address <- gsub("[.]", "", DC$Address)
DC$Address[which(DC$Address  == ", DC")] <- ""
```


Starting off with the first address set

```{r}
geocodedAllDC <- tidygeocoder::geocode(.tbl = DC, address = Address, method = "osm", lat = latitude, long = longitude)
geocodedAllDC
save(geocodedAllDC, file = "allDC.RData")
geocodedAllDC %>% filter(!is.na(latitude))
```

```{r}
load(file = "allDallas.RData")
```

```{r}
geocodedDallasFound <- geocodedAllDallas %>% filter(!is.na(latitude)) %>% filter( ((latitude > 32 & latitude < 34) & (longitude > -98 & longitude < -96)) )
geocodedDallasReDo <- geocodedAllDallas %>% filter(is.na(latitude) | !((latitude > 32 & latitude < 34) & (longitude > -98 & longitude < -96)) )
geocodedDallasReDo
geocodedDallasFound 
```

Now we geocode the set that we did not find 'geocodedLAReDo'. I use a google maps quote for this specifically, to get the best results. Google's system works far better for interpreting ambiguous inputs.

```{r}
geocodedDallasReDo <- geocodedDallasReDo %>% unite(Address, c("Hse.No","Street"), sep = " ",remove = FALSE)
geocodedDallasReDo$Address <- paste(geocodedDallasReDo$Address, ",Dallas, Texas") 
geocodedDallasReDo <- geocodedDallasReDo %>% select(-latitude, -longitude)
geocodedDallasReDo
```

```{r}
k <- "AIzaSyDNMoGGfgl9f5KtGCnp9BegNb7ZDqPu7gg"
register_google(key = k)
```

```{r}
#SecondDallas <- ggmap::mutate_geocode(geocodedDallasReDo, Address)
#save(SecondDallas, file = "SecondDallas.RData")
```


```{r}
load(file = "secondDallas.RData")
SecondDallas <- SecondDallas %>% mutate(latitude = lat) %>% mutate(longitude = lon) %>% select(-lat,-lon)
```

Bring the entire dataset back together.
Mark which columns were generated from google.

```{r}
geocodedDallasFound <- geocodedDallasFound %>% mutate(google = 0)
SecondDallas <- SecondDallas %>% mutate(google = 1)
dallasGeocoded <- rbind(geocodedDallasFound, SecondDallas)

dallasGeocoded <- dallasGeocoded %>% mutate(location = case_when(
    str_detect(location, "n dallas") ~ "north dallas",
    str_detect(location, "e dallas") ~ "east dallas",
    str_detect(location, "dallas") ~ "",
    str_detect(location, "suburban") ~ "",
    str_detect(location, "N NW Hwy") ~ "N NW Highway",
    str_detect(location, "n nw hwy, midway rd to central expwy") ~ "N NW Highway",
    str_detect(location, "N Northwest Hwy") ~ "N NW Highway",
    str_detect(location, "n nw hwy, w midway rd") ~ "N NW Highway",
    str_detect(location, "n of northwest highway") ~ "N NW Highway",
    str_detect(location, "n of nw hwy") ~ "N NW Highway",
    str_detect(location, "n nw hwy, e central expwy") ~ "N NW Highway",
    str_detect(location, "n of lbj") ~ "n lbj",
    str_detect(location, "n lbj, e addison, w richardson") ~ "n lbj",
    str_detect(location, "north of northwest highway") ~ "N NW Highway",
    str_detect(location, "oak cliff, w beckley") ~ "oak cliff",
    str_detect(location, "white rock lake - east") ~ "east white rock lake",
    str_detect(location, "e white rock lake") ~ "east white rock lake",
    str_detect(location, "e of white rock lake") ~ "east white rock lake",
    
    TRUE ~ location
    )
  )

save(dallasGeocoded, file = "dallasGeocoded.RData")
```


```{r}
load(file = "dallasGeocoded.RData")

dallas2 = dallasGeocoded %>% filter(location != "")
dallas2 %>% group_by(location) %>% summarise(count = n()) %>% arrange(desc(count))
```

```{r}
k <- "AIzaSyDNMoGGfgl9f5KtGCnp9BegNb7ZDqPu7gg"
register_google(key = k)
```



```{r} 
map <- get_map(location = 'Dallas', zoom = 10, maptype = "terrain-background", source = 'google', color = 'color')
ggmap(map) + geom_point(data = dallas2, mapping = aes(x = longitude, y = latitude, color = factor(location)), size = 0.1) + theme(legend.position = "none")

```

