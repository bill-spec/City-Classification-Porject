---
title: "KNN 40 Zone Testing"
author: "Bill Lang"
date: "7/23/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggmap)
library(class)
```

This first half will construct a random forest model on the 15,713 observations that have a full address and an area specification in the top 50.

Reading in file.

```{r}
load(file = "cleanBoston.RData")
bostonData <- bostonData %>% filter((Street != "") | (Cross.Street != "")) %>% filter(Hse.No != "")
bostonData
knn <- bostonData %>% mutate(type = ifelse(Price.type == "sale", 1,0)) %>% select(Area, latitude, longitude, capitalizedPrice, Total.rooms, Year, type, pricePerRoom)
knn
```

Removing areas with no information. 

```{r}
bostonData <- knn %>% filter(Area != "") 
bostonData <- bostonData %>% filter(pricePerRoom > 0)
bostonData <- bostonData %>% filter(!is.infinite(pricePerRoom))
```

Finding the top 50 labeled areas.

```{r}
bostonData$Area <- tolower(bostonData$Area)
tbl <- bostonData %>% group_by(Area) %>% summarise(count = n()) %>% arrange(desc(count))
listOfAreas <- tbl[1:50,]$Area
listOfAreas
save(listOfAreas, file = "AreasKNN.RData")
```

Find the observations with a top 50 area. 

```{r}
bostonAddress <- bostonData %>% filter(Area %in% listOfAreas) 
```

Finding the 15,713 observations with full addresses.

```{r}
#bostonAddress <- bostonAddress %>% filter((Street != "") | (Cross.Street != "")) %>% filter(Hse.No != "")
```

Filtering outliers in the geocoding process. These results were so far outside of Boston they are being treated as failed geocoding result and not considered.

```{r}
bostonAddress$Area <- as.factor(bostonAddress$Area)
bostonAddress <- bostonAddress %>% filter(!is.na(latitude))
bostonAddress <- bostonAddress %>% filter(latitude < 43) %>% filter(latitude > 42) %>% filter(longitude > -71.75)
```

Model Building on the first 15,000

This model is built on a random shuffle of the data and validated by holding out 20% of the dataset. 
 
```{r}
bostonAddress
modelData <- na.omit(bostonAddress)


set.seed(343)
shuf <- sample(nrow(modelData))
modelData <- modelData[shuf,]
train <- sample(nrow(modelData)*.8)

modelData$latitude <- scale(modelData$latitude)
modelData$longitude <- scale(modelData$longitude)
modelData$capitalizedPrice <- scale(modelData$capitalizedPrice)
modelData$Total.rooms <- scale(modelData$Total.rooms)
modelData$Year <- scale(modelData$Year)
modelData$type <- scale(modelData$type)
modelData$pricePerRoom <- scale(modelData$pricePerRoom)

modelData <- modelData %>% select(Area, latitude, longitude, pricePerRoom, capitalizedPrice, Total.rooms)
modelData

bostonTrain.x <- modelData[train,-1]
bostonTrain.x
bostonTrain.cl <- modelData[train,1]
 
bostonTest.x <- modelData[-train,-1]
bostonTest.x
bostonTest.cl <- modelData[-train,1]

```


```{r}
misclassVec <- c(1:100)

for(i in 1:100){
KNN.pred.temp <- knn(bostonTrain.x, bostonTest.x,cl =bostonTrain.cl, k =i)
misclassVec[i] <- mean(bostonTest.cl != KNN.pred.temp)
}
min(misclassVec); which.min(misclassVec)
misclassVec

KNN.pred <- knn(bostonTrain.x, bostonTest.x,cl =bostonTrain.cl, k =5)
mean(bostonTest.cl != KNN.pred)

```

```{r}

```

