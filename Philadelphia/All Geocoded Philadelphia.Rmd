---
title: "All Geodcoded Philadelphia"
author: "Bill Lang"
date: "2/3/2021"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggmap)
```



```{r}
load(file = "phil.RData")
phil %>% filter(area == "nj")

```


```{r}
phil %>% filter(area != "")
phil %>% group_by(columnlocation) %>% summarise(count = n()) %>% arrange(desc(count))
phil %>% group_by(area) %>% summarise(count = n()) %>% arrange(desc(count))
phil %>% filter(street != "")

#108122 with and 12650 without area, but a lot of these are just labeled as Philadelphia
#77780 with street
```


Dataset Specific preparation

Run in Open Street Map
House Number Address First
Then run the small location (if no small area then large area)


```{r}
phil$Area <- tolower(phil$area)
phil$Column.Location <- tolower(phil$columnlocation)
phil$street <- tolower(phil$street)

#Generate the new location based on the area first, then the columnlocation 
#Also we can remove philadelphia alone as an idicator because it is nto helpful

phil <- phil %>% mutate(location = ifelse(area != "", as.character(area), as.character(columnlocation))) %>% mutate(location = str_replace_all(location, "philadelphia", "")) %>%
  mutate(location = str_replace_all(location, "philadelphia", "")) %>% 
  mutate(location = str_replace_all(location, "city", ""))

phil %>% filter(location != "")

#74,759 not blank location
```


```{r}
#We can build the addres column to geocode

phil <- phil %>% unite(Address, c("hseno","street", "location"), sep = " ",remove = FALSE)
phil$Address <- paste(phil$Address, ", Philadelphia")
phil$Address <- trimws(phil$Address)

phil = phil %>% 
  mutate(Address = str_replace_all(Address, "#", "")) %>% 
  mutate(Address = str_replace_all(Address, "[.]"," ")) %>%
  mutate(Address = str_replace_all(Address, " ne ", " northeast ")) %>% 
  mutate(Address = str_replace_all(Address, "#ref!", "")) %>% 
  mutate(Address = str_replace_all(Address, " se "," southeast ")) %>% 
  mutate(Address = str_replace_all(Address, " sw "," southwest ")) %>% 
  mutate(Address = str_replace_all(Address, " nw ", " northwest ")) %>% 
  mutate(Address = str_replace_all(Address, "ny","new york")) %>% 
  mutate(Address = str_replace_all(Address, "n y", "new york") ) %>% 
  mutate(Address = str_replace_all(Address, "mass ","massachusetts ")) %>% 
  mutate(Address = str_replace_all(Address, "conn ","connecticut ") ) %>% 
  mutate(Address = str_replace_all(Address, " rd "," road ")) %>% 
  mutate(Address = str_replace_all(Address, " ave "," avenue ")) %>% 
  mutate(Address = str_replace_all(Address, " st "," street ")) %>% 
  mutate(Address = str_replace_all(Address, " ct "," court ")) %>%
  mutate(Address = str_replace_all(Address, " pl "," place ") ) %>%
  mutate(Address = str_replace_all(Address, " rd,"," road,")) %>% 
  mutate(Address = str_replace_all(Address, " ave,"," avenue,")) %>% 
  mutate(Address = str_replace_all(Address, " st,"," street,")) %>% 
  mutate(Address = str_replace_all(Address, " ct,"," court,")) %>%
  mutate(Address = str_replace_all(Address, " pl,"," place,") ) %>%
  mutate(Address = str_replace_all(Address, "americana","american") ) %>%
  mutate(Address = str_replace_all(Address, "near",""))

phil
```

Starting off with the first address set

```{r}
geocodeFirstPhil <- tidygeocoder::geocode(.tbl = phil, address = Address, method = "osm", lat = latitude, long = longitude)
geocodeFirstPhil
save(geocodeFirstPhil, file = "firstPhil.RData")
geocodeFirstPhil %>% filter(!is.na(latitude))
```

```{r}
load(file = "firstPhil.RData")
geocodeFirstPhil
```

```{r}
geocodedPhilFound <- geocodeFirstPhil %>% filter(!is.na(latitude)) %>% filter( ((latitude > 39.45 & latitude < 40.45) & (longitude > -76 & longitude < -74.3)) )
geocodedPhilReDo <- geocodeFirstPhil %>% filter(is.na(latitude) | !((latitude > 39.45 & latitude < 40.45) & (longitude > -76 & longitude < -74.3)) )
geocodedPhilFound
geocodedPhilReDo 
```

We redo the geocoding with a new address for each by removing the "location" data that was put in before.

```{r}
geocodedPhilReDo <- geocodedPhilReDo %>% unite(Address, c("hseno","street"), sep = " ",remove = FALSE)
geocodedPhilReDo$Address <- paste(geocodedPhilReDo$Address, ",Philadelphia") 
geocodedPhilReDo <- geocodedPhilReDo %>% select(-latitude, -longitude)
geocodedPhilReDo
```

```{r}
geocodeSecondPhil <- tidygeocoder::geocode(.tbl = geocodedPhilReDo, address = Address, method = "osm", lat = latitude, long = longitude)
geocodeSecondPhil
save(geocodeSecondPhil, file = "geocodeSecondPhil.RData")
geocodeSecondPhil %>% filter(!is.na(latitude))
```

```{r}
load(file = "geocodeSecondPhil.RData")
geocodeSecondPhil
```

```{r}
geocodedPhilFound2 <- geocodeSecondPhil %>% filter(!is.na(latitude)) %>% filter( ((latitude > 39.45 & latitude < 40.45) & (longitude > -76 & longitude < -74.3)) )
geocodedPhilReDo2 <- geocodeSecondPhil %>% filter(is.na(latitude) | !((latitude > 39.45 & latitude < 40.45) & (longitude > -76 & longitude < -74.45)) )
geocodedPhilFound2
geocodedPhilReDo2
```



Add the newly found rows into the entire dataset

```{r}
geocodedPhil <- rbind(geocodedPhilFound, geocodedPhilFound2)
geocodedPhil
```



Mapping

```{r}
k <- "AIzaSyDNMoGGfgl9f5KtGCnp9BegNb7ZDqPu7gg"
register_google(key = k)
```

```{r} 
map <- get_map(location = 'Philadelphia', zoom = 10, maptype = "terrain-background", source = 'google', color = 'color')
ggmap(map) + geom_point(data = geocodedPhil, mapping = aes(x = longitude, y = latitude, color = factor(location)), size = 0.1) + theme(legend.position = "none")
```




We redo the geocoding with a new address for each by removing the "location" data that was put in before.

```{r}
geocodedPhilReDo2 <- geocodedPhilReDo2 %>% unite(Address, c("Hse.No","Street"), sep = " ",remove = FALSE)
geocodedPhilReDo2$Address <- paste(geocodedPhilReDo2$Address, ",Michigan") 
geocodedPhilReDo2 <- geocodedPhilReDo2 %>% select(-latitude, -longitude)
geocodedPhilReDo2
```

```{r}
thirdDetroit <- tidygeocoder::geocode(.tbl = geocodedDetroitReDo2, address = Address, method = "osm", lat = latitude, long = longitude)
thirdDetroit
save(thirdDetroit, file = "thirdDetroit.RData")
secondDetroit %>% filter(!is.na(latitude))
```

```{r}
load(file = "thirdDetroit.RData")
thirdDetroit
```

```{r}
geocodedDetroitFound3 <- thirdDetroit %>% filter(!is.na(latitude)) %>% filter( ((latitude > 42 & latitude < 43) & (longitude > -84 & longitude < -82)) )
geocodedDetroitReDo3 <- thirdDetroit %>% filter(is.na(latitude) | !((latitude > 42 & latitude < 43) & (longitude > -84 & longitude < -82)) )
geocodedDetroitReDo3
geocodedDetroitFound3
```

Add the newly found rows into the entire dataset

```{r}
detroitGeocoded <- rbind(detroitGeocoded, geocodedDetroitFound3)
detroitGeocoded
```

```{r}
notGeocoded = geocodedDetroitReDo3
notGeocoded
save(notGeocoded, file = "notGeocoded.RData")
```

```{r}
save(detroitGeocoded, file = "detroitGeocoded.RData")
```



```{r}
k <- "AIzaSyDNMoGGfgl9f5KtGCnp9BegNb7ZDqPu7gg"
register_google(key = k)
```


```{r} 
map <- get_map(location = 'Detroit', zoom = 10, maptype = "terrain-background", source = 'google', color = 'color')
ggmap(map) + geom_point(data = detroitGeocoded, mapping = aes(x = longitude, y = latitude, color = factor(location)), size = 0.1) + theme(legend.position = "none")
```

